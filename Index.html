<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>思源學習 × 丘鋒元教練 元朗區開球網乒乓球季度積分榜</title>
    <style>
        :root {
            --primary-color: #3498db;
            --primary-dark: #2980b9;
            --secondary-color: #2ecc71;
            --secondary-dark: #27ae60;
            --accent-color: #e74c3c;
            --accent-dark: #c0392b;
            --dark-color: #2c3e50;
            --light-color: #ecf0f1;
            --border-color: #bdc3c7;
            --highlight-color: #f1c40f;
            --success-color: #2ecc71;
            --warning-color: #f39c12;
            --danger-color: #e74c3c;
            --info-color: #3498db;
        }
        
        body {
            font-family: 'Microsoft JhengHei', 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            line-height: 1.6;
            margin: 0;
            padding: 20px;
            color: var(--dark-color);
            max-width: 1200px;
            margin: 0 auto;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e8eb 100%);
        }
        
        h1, h2, h3, h4 {
            color: var(--dark-color);
            margin-top: 1.5em;
        }
        
        h1 {
            text-align: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 3px solid var(--primary-color);
            position: relative;
            font-size: 2.2em;
            color: var(--dark-color);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        h1:after {
            content: "";
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 100px;
            height: 3px;
            background: var(--secondary-color);
            border-radius: 3px;
        }
        
        h2 {
            border-left: 5px solid var(--primary-color);
            padding-left: 15px;
            margin-top: 40px;
            font-size: 1.6em;
            background: linear-gradient(to right, rgba(52, 152, 219, 0.1), transparent);
            border-radius: 0 5px 5px 0;
        }
        
        h3 {
            font-size: 1.4em;
            border-bottom: 2px dashed var(--border-color);
            padding-bottom: 5px;
            color: var(--primary-dark);
        }
        
        h4 {
            font-size: 1.2em;
            color: var(--secondary-dark);
        }
        
        .info-box {
            background-color: white;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            margin: 25px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 3px solid var(--primary-color);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 25px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            border-radius: 8px;
            overflow: hidden;
            background-color: white;
        }
        
        th, td {
            border: 1px solid var(--border-color);
            padding: 12px 15px;
            text-align: left;
        }
        
        th {
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: white;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.9em;
            letter-spacing: 0.5px;
        }
        
        tr:nth-child(even) {
            background-color: rgba(0,0,0,0.02);
        }
        
        tr:hover {
            background-color: rgba(52, 152, 219, 0.1);
        }
        
        .highlight {
            background-color: #fff3cd;
            padding: 3px 8px;
            border-radius: 4px;
            font-weight: 600;
            display: inline-block;
            margin: 2px 0;
        }
        
        .emoji {
            font-size: 1.2em;
            margin-right: 5px;
        }
        
        .footer {
            text-align: center;
            margin-top: 50px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            font-size: 0.9em;
            color: #666;
        }
        
        .financial-section {
            margin-top: 50px;
            background-color: white;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            border-top: 3px solid var(--secondary-color);
        }
        
        .note {
            font-size: 0.9em;
            color: #666;
            font-style: italic;
            margin: 10px 0;
            padding: 10px;
            background-color: rgba(52, 152, 219, 0.05);
            border-left: 3px solid var(--info-color);
            border-radius: 0 5px 5px 0;
        }
        
        .percentage {
            color: #666;
            font-size: 0.8em;
            display: block;
            margin-top: 3px;
        }
        
        .prize-adjustment {
            background-color: #e7f5fe;
            padding: 20px;
            border-radius: 8px;
            margin: 25px 0;
            border-left: 4px solid var(--secondary-color);
        }
        
        ul, ol {
            padding-left: 25px;
        }
        
        li {
            margin-bottom: 8px;
            position: relative;
        }
        
        li:before {
            content: "•";
            color: var(--primary-color);
            font-weight: bold;
            display: inline-block;
            width: 1em;
            margin-left: -1em;
            position: absolute;
            left: 0;
        }
        
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 20px;
            font-size: 0.8em;
            font-weight: bold;
            margin-left: 5px;
            vertical-align: middle;
        }
        
        .badge-new {
            background-color: var(--accent-color);
            color: white;
        }
        
        .grid-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .card {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            border-top: 3px solid var(--primary-color);
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.1);
        }
        
        .card h4 {
            margin-top: 0;
            color: var(--primary-color);
        }
        
        .timeline {
            position: relative;
            padding-left: 30px;
            margin: 20px 0;
        }
        
        .timeline:before {
            content: "";
            position: absolute;
            left: 10px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--primary-color);
        }
        
        .timeline-item {
            position: relative;
            margin-bottom: 20px;
        }
        
        .timeline-item:before {
            content: "";
            position: absolute;
            left: -30px;
            top: 5px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--secondary-color);
            border: 2px solid white;
            box-shadow: 0 0 0 2px var(--secondary-color);
        }
        
        .timeline-time {
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .btn {
            display: inline-block;
            background: linear-gradient(to right, var(--primary-color), var(--primary-dark));
            color: white;
            padding: 10px 20px;
            border-radius: 4px;
            text-decoration: none;
            font-weight: bold;
            margin: 10px 0;
            transition: all 0.3s;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .btn:hover {
            background: linear-gradient(to right, var(--primary-dark), var(--primary-color));
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn:active {
            transform: translateY(0);
            box-shadow: 0 2px 3px rgba(0,0,0,0.1);
        }
        
        .btn-secondary {
            background: linear-gradient(to right, var(--secondary-color), var(--secondary-dark));
        }
        
        .btn-secondary:hover {
            background: linear-gradient(to right, var(--secondary-dark), var(--secondary-color));
        }
        
        .btn-danger {
            background: linear-gradient(to right, var(--danger-color), var(--accent-dark));
        }
        
        .btn-danger:hover {
            background: linear-gradient(to right, var(--accent-dark), var(--danger-color));
        }
        
        .btn-warning {
            background: linear-gradient(to right, var(--warning-color), #e67e22);
        }
        
        .btn-warning:hover {
            background: linear-gradient(to right, #e67e22, var(--warning-color));
        }
        
        .contact-item {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .contact-icon {
            margin-right: 10px;
            font-size: 1.2em;
            color: var(--primary-color);
            width: 25px;
            text-align: center;
        }
        
        .currency-note {
            background-color: #f0f7ff;
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-size: 0.9em;
        }
        
        .payment-flow {
            max-width: 100%;
            margin: 20px 0;
            border: 1px solid #ddd;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .tab {
            padding: 12px 20px;
            cursor: pointer;
            border: 1px solid transparent;
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            background-color: #f1f1f1;
            transition: all 0.3s;
            font-weight: 500;
        }
        
        .tab:hover {
            background-color: #e1e1e1;
        }
        
        .tab.active {
            background-color: white;
            border-color: var(--border-color);
            border-bottom: 1px solid white;
            margin-bottom: -1px;
            font-weight: bold;
            color: var(--primary-color);
            box-shadow: 0 -3px 5px rgba(0,0,0,0.05);
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: var(--dark-color);
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            box-sizing: border-box;
            transition: border 0.3s, box-shadow 0.3s;
            font-family: inherit;
        }
        
        input:focus, select:focus, textarea:focus {
            border-color: var(--primary-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .medal-gold {
            background: linear-gradient(135deg, gold, #ffd700);
            color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .medal-silver {
            background: linear-gradient(135deg, silver, #c0c0c0);
            color: #333;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .medal-bronze {
            background: linear-gradient(135deg, #cd7f32, #b87333);
            color: white;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: bold;
            display: inline-block;
            min-width: 24px;
            text-align: center;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .rank-1 {
            background-color: rgba(255, 215, 0, 0.1);
        }
        
        .rank-2 {
            background-color: rgba(192, 192, 192, 0.1);
        }
        
        .rank-3 {
            background-color: rgba(205, 127, 50, 0.1);
        }
        
        .rank-highlight {
            background-color: rgba(46, 204, 113, 0.1);
        }
        
        .player-photo {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            object-fit: cover;
            margin-right: 10px;
            border: 2px solid var(--border-color);
        }
        
        .player-cell {
            display: flex;
            align-items: center;
        }
        
        .player-name {
            font-weight: bold;
        }
        
        .player-id {
            font-size: 0.8em;
            color: #666;
        }
        
        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .hidden {
            display: none;
        }
        
        .export-import {
            margin: 20px 0;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px dashed var(--border-color);
        }
        
        textarea {
            width: 100%;
            min-height: 100px;
            padding: 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: monospace;
            resize: vertical;
        }
        
        .input-method-tabs {
            display: flex;
            margin-bottom: 0;
            border-bottom: 1px solid var(--border-color);
        }
        
        .input-method-tab {
            padding: 8px 15px;
            cursor: pointer;
            background-color: #f1f1f1;
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: 5px 5px 0 0;
            margin-right: 5px;
            transition: all 0.3s;
        }
        
        .input-method-tab:hover {
            background-color: #e1e1e1;
        }
        
        .input-method-tab.active {
            background-color: white;
            font-weight: bold;
            color: var(--primary-color);
            box-shadow: 0 -3px 5px rgba(0,0,0,0.05);
        }
        
        .input-method-content {
            display: none;
            padding: 15px;
            border: 1px solid var(--border-color);
            border-radius: 0 5px 5px 5px;
            background-color: white;
            margin-top: -1px;
        }
        
        .input-method-content.active {
            display: block;
            animation: fadeIn 0.3s ease-in-out;
        }
        
        .points-table {
            width: auto;
            margin: 20px 0;
        }
        
        .points-table th, .points-table td {
            padding: 8px 12px;
            text-align: center;
        }
        
        .event-performance {
            font-size: 0.9em;
            color: #666;
        }
        
        .event-performance span {
            display: inline-block;
            margin-right: 10px;
        }
        
        .performance-icon {
            margin-right: 3px;
            color: var(--primary-color);
        }
        
        .points-difference {
            font-weight: bold;
        }
        
        .points-difference.positive {
            color: var(--success-color);
        }
        
        .points-difference.negative {
            color: var(--danger-color);
        }
        
        .chance-indicator {
            display: inline-block;
            width: 60px;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
            margin-right: 5px;
            vertical-align: middle;
        }
        
        .chance-bar {
            height: 100%;
            background: linear-gradient(to right, var(--secondary-color), var(--success-color));
            border-radius: 5px;
        }
        
        .chance-text {
            font-size: 0.9em;
            color: var(--dark-color);
            vertical-align: middle;
        }
        
        .progress-container {
            width: 100%;
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            margin: 5px 0;
            overflow: hidden;
        }
        
        .progress-bar {
            height: 100%;
            background: linear-gradient(to right, var(--primary-color), var(--secondary-color));
            border-radius: 5px;
            transition: width 0.5s ease-in-out;
        }
        
        .stats-container {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
        }
        
        .stat-box {
            flex: 1;
            padding: 10px;
            background-color: white;
            border-radius: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            margin: 0 5px;
            text-align: center;
            border-top: 3px solid var(--primary-color);
        }
        
        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: var(--primary-color);
        }
        
        .stat-label {
            font-size: 0.8em;
            color: #666;
        }
        
        .season-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .season-tab {
            padding: 8px 15px;
            background-color: #f1f1f1;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
            position: relative;
        }
        
        .season-tab:hover {
            background-color: #e1e1e1;
        }
        
        .season-tab.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }
        
        .season-date {
            font-size: 0.7em;
            opacity: 0.8;
            display: block;
            margin-top: 2px;
        }
        
        .current-season-marker {
            position: absolute;
            top: -5px;
            right: -5px;
            width: 10px;
            height: 10px;
            background-color: var(--accent-color);
            border-radius: 50%;
            border: 2px solid white;
        }
        
        @media (max-width: 768px) {
            body {
                padding: 15px;
            }
            
            h1 {
                font-size: 1.8em;
            }
            
            .grid-container {
                grid-template-columns: 1fr;
            }
            
            table {
                font-size: 0.9em;
            }
            
            th, td {
                padding: 8px 10px;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .action-buttons {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
            
            .stats-container {
                flex-direction: column;
            }
            
            .stat-box {
                margin: 5px 0;
            }
            
            .season-selector {
                gap: 5px;
            }
            
            .season-tab {
                padding: 6px 10px;
                font-size: 0.9em;
            }
        }
    </style>
</head>
<body>
    <h1>思源學習 × 丘鋒元教練 元朗區開球網乒乓球季度積分榜</h1>
    
    <div class="info-box">
        <p>本系統用於計算和顯示季度性乒乓球比賽積分排名，無需伺服器支援，所有數據存儲在瀏覽器本地。</p>
        <p><strong>當前季度：</strong> <span id="quarter-range"></span></p>
        <p id="current-date-display"></p>
    </div>
    
    <div class="tabs">
        <div class="tab active" data-tab="ranking">季度排名榜</div>
        <div class="tab" data-tab="players">球員管理</div>
        <div class="tab" data-tab="events">賽事管理</div>
        <div class="tab" data-tab="settings">系統設定</div>
    </div>
    
    <div class="tab-content active" id="ranking-tab">
        <h2>季度積分排名</h2>
        
        <div id="season-selector" class="season-selector">
            <div class="season-tab active" data-season="current">
                本季度
                <span class="season-date" id="current-quarter-date"></span>
                <span class="current-season-marker"></span>
            </div>
            <div class="season-tab" data-season="2025-Q2">
                2025 Q2
                <span class="season-date">4月 - 6月</span>
            </div>
            <div class="season-tab" data-season="2025-Q3">
                2025 Q3
                <span class="season-date">7月 - 9月</span>
            </div>
            <div class="season-tab" data-season="2025-Q4">
                2025 Q4
                <span class="season-date">10月 - 12月</span>
            </div>
            <div class="season-tab" data-season="2026-Q1">
                2026 Q1
                <span class="season-date">1月 - 3月</span>
            </div>
            <div class="season-tab" data-season="all">
                所有季度
                <span class="season-date">全部賽事</span>
            </div>
        </div>
        
        <div class="stats-container">
            <div class="stat-box">
                <div class="stat-value" id="total-players">0</div>
                <div class="stat-label">註冊球員</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="total-events">0</div>
                <div class="stat-label">已舉辦賽事</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="active-players">0</div>
                <div class="stat-label">活躍球員</div>
            </div>
            <div class="stat-box">
                <div class="stat-value" id="avg-points">0</div>
                <div class="stat-label">平均積分</div>
            </div>
        </div>
        
        <div class="form-row">
            <div class="form-group">
                <label for="filter-search">搜尋球員</label>
                <input type="text" id="filter-search" placeholder="輸入球員姓名">
            </div>
        </div>
        
        <table id="ranking-table">
            <thead>
                <tr>
                    <th>排名</th>
                    <th>球員</th>
                    <th>總積分</th>
                    <th>參賽次數</th>
                    <th>最佳名次</th>
                    <th>與第一名差距</th>
                    <th>冠軍機會率</th>
                    <th>賽事表現</th>
                </tr>
            </thead>
            <tbody id="ranking-body">
                <!-- 排名數據將在這裡動態生成 -->
            </tbody>
        </table>
        
        <div class="note">
            <p><strong>積分計算規則：</strong></p>
            <ol>
                <li>每場比賽根據最終名次獲得相應積分</li>
                <li>積分分配：第1名12分，第2名11分，...，第12名1分</li>
                <li>第13名及以後不獲得分數</li>
                <li>季度總積分為所有比賽積分的總和</li>
                <li>冠軍機會率基於當前積分、參賽頻率和得分趨勢計算</li>
            </ol>
        </div>
    </div>
    
    <div class="tab-content" id="players-tab">
        <h2>球員管理</h2>
        
        <div class="input-method-tabs">
            <div class="input-method-tab active" data-method="single">單一輸入</div>
            <div class="input-method-tab" data-method="bulk">接龍式輸入</div>
        </div>
        
        <div class="input-method-content active" id="single-input">
            <div class="form-group">
                <label for="player-name">球員姓名</label>
                <input type="text" id="player-name" placeholder="輸入球員姓名">
            </div>
            <button class="btn" id="add-player">新增球員</button>
        </div>
        
        <div class="input-method-content" id="bulk-input">
            <div class="form-group">
                <label for="bulk-players">接龍式輸入球員 (每行一個姓名)</label>
                <textarea id="bulk-players" placeholder="請輸入球員姓名，每行一個：
例：
張三
李四
王五
..."></textarea>
            </div>
            <button class="btn" id="add-bulk-players">批量新增球員</button>
        </div>
        
        <table id="players-table">
            <thead>
                <tr>
                    <th>編號</th>
                    <th>姓名</th>
                    <th>參賽次數</th>
                    <th>總積分</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="players-body">
                <!-- 球員數據將在這裡動態生成 -->
            </tbody>
        </table>
    </div>
    
    <div class="tab-content" id="events-tab">
        <h2>賽事管理</h2>
        
        <div class="form-row">
            <div class="form-group">
                <label for="event-date">比賽日期</label>
                <input type="date" id="event-date">
            </div>
            <div class="form-group">
                <label for="event-location">比賽地點</label>
                <input type="text" id="event-location" placeholder="輸入比賽地點">
            </div>
        </div>
        
        <div class="form-group">
            <label for="event-season">所屬季度</label>
            <select id="event-season">
                <option value="2025-Q2">2025年第二季度 (4-6月)</option>
                <option value="2025-Q3">2025年第三季度 (7-9月)</option>
                <option value="2025-Q4">2025年第四季度 (10-12月)</option>
                <option value="2026-Q1">2026年第一季度 (1-3月)</option>
            </select>
        </div>
        
        <h3>參賽球員及名次</h3>
        
        <div class="input-method-tabs">
            <div class="input-method-tab active" data-method="single">單一輸入</div>
            <div class="input-method-tab" data-method="bulk">接龍式輸入</div>
        </div>
        
        <div class="input-method-content active" id="single-event-input">
            <div class="form-row">
                <div class="form-group" style="flex: 2;">
                    <label for="select-player">選擇球員</label>
                    <select id="select-player">
                        <option value="">-- 選擇球員 --</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="player-rank">名次</label>
                    <input type="number" id="player-rank" min="1" placeholder="輸入名次">
                </div>
                <div class="form-group" style="align-self: flex-end;">
                    <button class="btn" id="add-result">添加結果</button>
                </div>
            </div>
        </div>
        
        <div class="input-method-content" id="bulk-event-input">
            <div class="form-group">
                <label for="bulk-results">接龍式輸入名次 (按名次排列，每行一個球員)</label>
                <textarea id="bulk-results" placeholder="請按名次排列輸入球員姓名，每行一個：
例：
張三
李四
王五
..."></textarea>
            </div>
            <button class="btn" id="process-bulk-results">處理接龍名次</button>
        </div>
        
        <h4>積分分配表</h4>
        <table class="points-table">
            <thead>
                <tr>
                    <th>名次</th>
                    <th>獲得積分</th>
                </tr>
            </thead>
            <tbody>
                <tr><td>第1名</td><td>12</td></tr>
                <tr><td>第2名</td><td>11</td></tr>
                <tr><td>第3名</td><td>10</td></tr>
                <tr><td>第4名</td><td>9</td></tr>
                <tr><td>第5名</td><td>8</td></tr>
                <tr><td>第6名</td><td>7</td></tr>
                <tr><td>第7名</td><td>6</td></tr>
                <tr><td>第8名</td><td>5</td></tr>
                <tr><td>第9名</td><td>4</td></tr>
                <tr><td>第10名</td><td>3</td></tr>
                <tr><td>第11名</td><td>2</td></tr>
                <tr><td>第12名</td><td>1</td></tr>
                <tr><td>第13名+</td><td>0</td></tr>
            </tbody>
        </table>
        
        <table id="event-results-table">
            <thead>
                <tr>
                    <th>名次</th>
                    <th>球員</th>
                    <th>獲得積分</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="event-results-body">
                <!-- 賽事結果將在這裡動態生成 -->
            </tbody>
        </table>
        
        <div class="action-buttons">
            <button class="btn" id="save-event">儲存賽事</button>
            <button class="btn btn-secondary" id="cancel-event">取消</button>
        </div>
        
        <h3>歷史賽事</h3>
        <table id="events-table">
            <thead>
                <tr>
                    <th>日期</th>
                    <th>地點</th>
                    <th>季度</th>
                    <th>參賽人數</th>
                    <th>冠軍</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="events-body">
                <!-- 賽事列表將在這裡動態生成 -->
            </tbody>
        </table>
    </div>
    
    <div class="tab-content" id="settings-tab">
        <h2>系統設定</h2>
        
        <div class="export-import">
            <h3>數據備份與恢復</h3>
            <p>將所有系統數據導出為JSON格式，或從JSON文件導入數據。</p>
            
            <div class="form-group">
                <label for="export-data">導出數據</label>
                <textarea id="export-data" readonly></textarea>
                <button class="btn" id="copy-data">複製數據</button>
                <button class="btn btn-secondary" id="download-data">下載數據文件</button>
            </div>
            
            <div class="form-group">
                <label for="import-data">導入數據</label>
                <textarea id="import-data" placeholder="粘貼JSON數據或選擇文件"></textarea>
                <input type="file" id="file-upload" accept=".json" class="hidden">
                <button class="btn" id="upload-data">選擇文件</button>
                <button class="btn btn-secondary" id="import-submit">導入數據</button>
            </div>
        </div>
        
        <div class="form-group">
            <h3>季度設定</h3>
            <div class="form-row">
                <div class="form-group">
                    <label for="current-quarter">當前季度</label>
                    <select id="current-quarter">
                        <option value="2025-Q2">2025年第二季度 (4-6月)</option>
                        <option value="2025-Q3">2025年第三季度 (7-9月)</option>
                        <option value="2025-Q4">2025年第四季度 (10-12月)</option>
                        <option value="2026-Q1">2026年第一季度 (1-3月)</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="quarter-start">季度開始日期</label>
                    <input type="date" id="quarter-start">
                </div>
                <div class="form-group">
                    <label for="quarter-end">季度結束日期</label>
                    <input type="date" id="quarter-end">
                </div>
            </div>
            <button class="btn" id="save-quarter">儲存季度設定</button>
        </div>
    </div>
    
    <div class="footer">
        <p>思源學習 × 丘鋒元教練 元朗區開球網乒乓球季度積分系統</p>
        <p>© 2025 版權所有 | 版本 1.4</p>
    </div>

    <script>
        // 系統數據結構
        let systemData = {
            players: [],
            events: [],
            settings: {
                currentQuarter: '2025-Q2',
                quarterStart: '2025-04-01',
                quarterEnd: '2025-06-30',
                quarters: {
                    '2025-Q2': { start: '2025-04-01', end: '2025-06-30', name: '2025年第二季度' },
                    '2025-Q3': { start: '2025-07-01', end: '2025-09-30', name: '2025年第三季度' },
                    '2025-Q4': { start: '2025-10-01', end: '2025-12-31', name: '2025年第四季度' },
                    '2026-Q1': { start: '2026-01-01', end: '2026-03-31', name: '2026年第一季度' }
                }
            }
        };

        // 當前編輯狀態
        let currentState = {
            editingPlayer: null,
            editingEvent: null,
            eventResults: [],
            inputMethod: 'single',
            selectedSeason: 'current'
        };

        // DOM元素
        const elements = {
            tabs: document.querySelectorAll('.tab'),
            tabContents: document.querySelectorAll('.tab-content'),
            quarterRange: document.getElementById('quarter-range'),
            currentQuarterDate: document.getElementById('current-quarter-date'),
            currentDateDisplay: document.getElementById('current-date-display'),
            rankingBody: document.getElementById('ranking-body'),
            playersBody: document.getElementById('players-body'),
            eventsBody: document.getElementById('events-body'),
            eventResultsBody: document.getElementById('event-results-body'),
            playerName: document.getElementById('player-name'),
            addPlayer: document.getElementById('add-player'),
            eventDate: document.getElementById('event-date'),
            eventLocation: document.getElementById('event-location'),
            eventSeason: document.getElementById('event-season'),
            selectPlayer: document.getElementById('select-player'),
            playerRank: document.getElementById('player-rank'),
            addResult: document.getElementById('add-result'),
            saveEvent: document.getElementById('save-event'),
            cancelEvent: document.getElementById('cancel-event'),
            filterSearch: document.getElementById('filter-search'),
            exportData: document.getElementById('export-data'),
            importData: document.getElementById('import-data'),
            copyData: document.getElementById('copy-data'),
            downloadData: document.getElementById('download-data'),
            uploadData: document.getElementById('upload-data'),
            fileUpload: document.getElementById('file-upload'),
            importSubmit: document.getElementById('import-submit'),
            currentQuarter: document.getElementById('current-quarter'),
            quarterStart: document.getElementById('quarter-start'),
            quarterEnd: document.getElementById('quarter-end'),
            saveQuarter: document.getElementById('save-quarter'),
            inputMethodTabs: document.querySelectorAll('.input-method-tab'),
            inputMethodContents: document.querySelectorAll('.input-method-content'),
            bulkPlayers: document.getElementById('bulk-players'),
            addBulkPlayers: document.getElementById('add-bulk-players'),
            bulkResults: document.getElementById('bulk-results'),
            processBulkResults: document.getElementById('process-bulk-results'),
            seasonTabs: document.querySelectorAll('.season-tab'),
            totalPlayers: document.getElementById('total-players'),
            totalEvents: document.getElementById('total-events'),
            activePlayers: document.getElementById('active-players'),
            avgPoints: document.getElementById('avg-points')
        };

        // 初始化系統
        function initSystem() {
            // 從本地存儲加載數據
            const savedData = localStorage.getItem('pingpongRankingSystem');
            if (savedData) {
                systemData = JSON.parse(savedData);
                
                // 確保quarters數據存在
                if (!systemData.settings.quarters) {
                    systemData.settings.quarters = {
                        '2025-Q2': { start: '2025-04-01', end: '2025-06-30', name: '2025年第二季度' },
                        '2025-Q3': { start: '2025-07-01', end: '2025-09-30', name: '2025年第三季度' },
                        '2025-Q4': { start: '2025-10-01', end: '2025-12-31', name: '2025年第四季度' },
                        '2026-Q1': { start: '2026-01-01', end: '2026-03-31', name: '2026年第一季度' }
                    };
                }
            }

            // 設置當前日期
            const today = new Date();
            const todayStr = today.toISOString().split('T')[0];
            elements.eventDate.value = todayStr;
            
            // 顯示當前日期
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            elements.currentDateDisplay.textContent = `當前日期：${today.toLocaleDateString('zh-Hant', options)}`;
            
            // 自動檢測當前季度
            detectCurrentQuarter(today);

            // 初始化UI
            updateQuarterDisplay();
            renderPlayersDropdown();
            renderPlayersTable();
            renderEventsTable();
            renderRankingTable();

            // 設置事件監聽器
            setupEventListeners();
        }

        // 檢測當前季度
        function detectCurrentQuarter(date) {
            const year = date.getFullYear();
            const month = date.getMonth() + 1; // 0-11 → 1-12
            
            let quarter;
            if (month >= 4 && month <= 6) {
                quarter = `${year}-Q2`;
            } else if (month >= 7 && month <= 9) {
                quarter = `${year}-Q3`;
            } else if (month >= 10 && month <= 12) {
                quarter = `${year}-Q4`;
            } else {
                quarter = `${year}-Q1`;
            }
            
            // 如果系統中沒有這個季度，創建它
            if (!systemData.settings.quarters[quarter]) {
                let start, end, name;
                if (quarter.endsWith('Q1')) {
                    start = `${year}-01-01`;
                    end = `${year}-03-31`;
                    name = `${year}年第一季度`;
                } else if (quarter.endsWith('Q2')) {
                    start = `${year}-04-01`;
                    end = `${year}-06-30`;
                    name = `${year}年第二季度`;
                } else if (quarter.endsWith('Q3')) {
                    start = `${year}-07-01`;
                    end = `${year}-09-30`;
                    name = `${year}年第三季度`;
                } else if (quarter.endsWith('Q4')) {
                    start = `${year}-10-01`;
                    end = `${year}-12-31`;
                    name = `${year}年第四季度`;
                }
                
                systemData.settings.quarters[quarter] = { start, end, name };
            }
            
            // 設置當前季度
            systemData.settings.currentQuarter = quarter;
            systemData.settings.quarterStart = systemData.settings.quarters[quarter].start;
            systemData.settings.quarterEnd = systemData.settings.quarters[quarter].end;
            
            // 更新選中的季度
            currentState.selectedSeason = 'current';
        }

        // 更新季度顯示
        function updateQuarterDisplay() {
            const startDate = new Date(systemData.settings.quarterStart);
            const endDate = new Date(systemData.settings.quarterEnd);
            
            const options = { year: 'numeric', month: 'long', day: 'numeric' };
            const startStr = startDate.toLocaleDateString('zh-Hant', options);
            const endStr = endDate.toLocaleDateString('zh-Hant', options);
            
            elements.quarterRange.textContent = `${systemData.settings.quarters[systemData.settings.currentQuarter]?.name || systemData.settings.currentQuarter} (${startStr} 至 ${endStr})`;
            elements.currentQuarterDate.textContent = `${formatDateShort(systemData.settings.quarterStart)} - ${formatDateShort(systemData.settings.quarterEnd)}`;
            
            // 更新設定中的季度選項
            elements.currentQuarter.value = systemData.settings.currentQuarter;
            elements.quarterStart.value = systemData.settings.quarterStart;
            elements.quarterEnd.value = systemData.settings.quarterEnd;
            
            // 更新賽事季度的選項
            updateSeasonOptions();
        }

        // 格式化短日期 (MM-DD)
        function formatDateShort(dateStr) {
            const date = new Date(dateStr);
            return `${date.getMonth() + 1}月${date.getDate()}日`;
        }

        // 更新賽事季度的選項
        function updateSeasonOptions() {
            const select = elements.eventSeason;
            select.innerHTML = '';
            
            // 按季度排序
            const sortedQuarters = Object.keys(systemData.settings.quarters).sort();
            
            sortedQuarters.forEach(quarter => {
                const option = document.createElement('option');
                option.value = quarter;
                option.textContent = systemData.settings.quarters[quarter].name;
                select.appendChild(option);
            });
            
            // 設置默認選中當前季度
            select.value = systemData.settings.currentQuarter;
        }

        // 渲染球員下拉選單
        function renderPlayersDropdown() {
            elements.selectPlayer.innerHTML = '<option value="">-- 選擇球員 --</option>';
            
            systemData.players.forEach(player => {
                const option = document.createElement('option');
                option.value = player.id;
                option.textContent = player.name;
                elements.selectPlayer.appendChild(option);
            });
        }

        // 渲染球員表格
        function renderPlayersTable() {
            elements.playersBody.innerHTML = '';
            
            systemData.players.forEach(player => {
                // 計算球員參賽次數和總積分
                const playerResults = systemData.events.flatMap(event => 
                    event.results.filter(result => result.playerId === player.id)
                );
                
                const eventCount = playerResults.length;
                const totalPoints = playerResults.reduce((sum, result) => sum + result.points, 0);
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${player.id}</td>
                    <td>${player.name}</td>
                    <td>${eventCount}</td>
                    <td>${totalPoints}</td>
                    <td>
                        <button class="btn btn-secondary delete-player" data-id="${player.id}">刪除</button>
                    </td>
                `;
                elements.playersBody.appendChild(row);
            });
            
            // 更新統計數據
            updateStats();
            
            // 添加刪除按鈕的事件監聽器
            document.querySelectorAll('.delete-player').forEach(button => {
                button.addEventListener('click', () => deletePlayer(button.dataset.id));
            });
        }

        // 更新統計數據
        function updateStats() {
            elements.totalPlayers.textContent = systemData.players.length;
            elements.totalEvents.textContent = systemData.events.length;
            
            // 計算活躍球員（本季度有參賽的球員）
            const currentSeason = systemData.settings.currentQuarter;
            const activePlayers = new Set();
            
            systemData.events.forEach(event => {
                if (event.season === currentSeason) {
                    event.results.forEach(result => {
                        activePlayers.add(result.playerId);
                    });
                }
            });
            
            elements.activePlayers.textContent = activePlayers.size;
            
            // 計算平均積分
            const playerStats = calculateQuarterlyRankings('current');
            const avgPoints = playerStats.length > 0 ? 
                (playerStats.reduce((sum, player) => sum + player.totalPoints, 0) / playerStats.length).toFixed(1) : 0;
            elements.avgPoints.textContent = avgPoints;
        }

        // 渲染賽事表格
        function renderEventsTable() {
            elements.eventsBody.innerHTML = '';
            
            // 按日期排序賽事
            const sortedEvents = [...systemData.events].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            sortedEvents.forEach(event => {
                const date = new Date(event.date);
                const dateStr = date.toLocaleDateString('zh-Hant');
                
                // 找出冠軍
                const championResult = event.results.find(r => r.rank === 1);
                const champion = championResult ? 
                    systemData.players.find(p => p.id === championResult.playerId)?.name : '--';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${dateStr}</td>
                    <td>${event.location}</td>
                    <td>${systemData.settings.quarters[event.season]?.name || event.season}</td>
                    <td>${event.results.length}</td>
                    <td>${champion}</td>
                    <td>
                        <button class="btn btn-secondary view-event" data-id="${event.id}">查看</button>
                        <button class="btn btn-danger delete-event" data-id="${event.id}">刪除</button>
                    </td>
                `;
                elements.eventsBody.appendChild(row);
            });
            
            // 更新統計數據
            updateStats();
            
            // 添加查看和刪除按鈕的事件監聽器
            document.querySelectorAll('.view-event').forEach(button => {
                button.addEventListener('click', () => viewEvent(button.dataset.id));
            });
            
            document.querySelectorAll('.delete-event').forEach(button => {
                button.addEventListener('click', () => deleteEvent(button.dataset.id));
            });
        }

        // 渲染排名表格
        function renderRankingTable(filterSeason = 'current', searchTerm = '') {
            elements.rankingBody.innerHTML = '';
            
            // 計算每個球員的季度積分
            const playerStats = calculateQuarterlyRankings(filterSeason);
            
            // 篩選球員
            const filteredPlayers = playerStats.filter(player => 
                player.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            // 按總積分排序
            filteredPlayers.sort((a, b) => b.totalPoints - a.totalPoints);
            
            // 找出最高分
            const maxPoints = filteredPlayers.length > 0 ? filteredPlayers[0].totalPoints : 0;
            
            // 渲染排名
            filteredPlayers.forEach((player, index) => {
                const bestRank = player.results.length > 0 ? 
                    Math.min(...player.results.map(r => r.rank)) : '--';
                
                // 計算與第一名的差距
                const pointsDiff = maxPoints - player.totalPoints;
                const pointsDiffText = pointsDiff > 0 ? 
                    `<span class="points-difference negative">-${pointsDiff}</span>` : 
                    '<span class="points-difference positive">0</span>';
                
                // 計算冠軍機會率
                const chance = calculateChance(player, filteredPlayers, maxPoints);
                const chanceText = `<span class="chance-indicator"><span class="chance-bar" style="width: ${chance}%"></span></span>
                                   <span class="chance-text">${chance}%</span>`;
                
                // 生成賽事表現信息
                const performance = player.results.map(result => {
                    const event = systemData.events.find(e => e.id === result.eventId);
                    const date = event ? new Date(event.date).toLocaleDateString('zh-Hant', {month: 'short', day: 'numeric'}) : '';
                    return `<span title="${date} 第${result.rank}名">${result.points}</span>`;
                }).join(', ');
                
                const row = document.createElement('tr');
                if (index === 0) row.classList.add('rank-1');
                else if (index === 1) row.classList.add('rank-2');
                else if (index === 2) row.classList.add('rank-3');
                
                row.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${player.name}</td>
                    <td>${player.totalPoints}</td>
                    <td>${player.results.length}</td>
                    <td>${bestRank === 1 ? '<span class="medal-gold">1</span>' : 
                        bestRank === 2 ? '<span class="medal-silver">2</span>' : 
                        bestRank === 3 ? '<span class="medal-bronze">3</span>' : bestRank}</td>
                    <td>${pointsDiffText}</td>
                    <td>${chanceText}</td>
                    <td class="event-performance">${performance}</td>
                `;
                elements.rankingBody.appendChild(row);
            });
        }

        // 計算冠軍機會率
        function calculateChance(player, allPlayers, maxPoints) {
            if (player.totalPoints === maxPoints && maxPoints > 0) return 100;
            
            // 簡單的預測模型
            const pointsDiff = maxPoints - player.totalPoints;
            const participationRate = player.results.length / systemData.events.length;
            const avgPoints = player.results.length > 0 ? 
                player.totalPoints / player.results.length : 0;
            
            // 計算機會率
            let chance = 100 - (pointsDiff * 5); // 每差1分減少5%機會
            chance = chance * (0.5 + participationRate * 0.5); // 考慮參賽頻率
            chance = chance * (0.7 + avgPoints / 12 * 0.3); // 考慮平均得分
            
            // 確保在合理範圍內
            chance = Math.max(0, Math.min(99, chance));
            
            // 四捨五入
            return Math.round(chance);
        }

        // 計算季度排名
        function calculateQuarterlyRankings(filterSeason) {
            const season = filterSeason === 'current' ? systemData.settings.currentQuarter : 
                          filterSeason === 'all' ? null : filterSeason;
            
            // 獲取所有球員
            const players = systemData.players.map(player => {
                // 找出該球員在所有賽事中的成績
                const results = [];
                
                systemData.events.forEach(event => {
                    if (season && event.season !== season) return;
                    
                    const result = event.results.find(r => r.playerId === player.id);
                    if (result) {
                        results.push({
                            date: event.date,
                            rank: result.rank,
                            points: result.points,
                            eventId: event.id
                        });
                    }
                });
                
                // 計算總積分
                const totalPoints = results.reduce((sum, r) => sum + r.points, 0);
                
                return {
                    id: player.id,
                    name: player.name,
                    results,
                    totalPoints
                };
            });
            
            return players.filter(p => p.results.length > 0 || filterSeason === 'all');
        }

        // 添加新球員
        function addPlayer() {
            const name = elements.playerName.value.trim();
            
            if (!name) {
                alert('請輸入球員姓名');
                return;
            }
            
            // 檢查姓名是否已存在
            if (systemData.players.some(player => player.name === name)) {
                alert('此球員姓名已存在');
                return;
            }
            
            // 添加新球員
            systemData.players.push({
                id: generatePlayerId(),
                name
            });
            
            // 保存數據並更新UI
            saveData();
            elements.playerName.value = '';
            renderPlayersDropdown();
            renderPlayersTable();
            renderRankingTable(currentState.selectedSeason);
        }

        // 批量添加球員
        function addBulkPlayers() {
            const text = elements.bulkPlayers.value.trim();
            if (!text) {
                alert('請輸入球員姓名');
                return;
            }
            
            const names = text.split('\n').filter(name => name.trim() !== '');
            if (names.length === 0) {
                alert('至少需要輸入一個球員姓名');
                return;
            }
            
            let addedCount = 0;
            names.forEach(name => {
                name = name.trim();
                if (name && !systemData.players.some(player => player.name === name)) {
                    systemData.players.push({
                        id: generatePlayerId(),
                        name
                    });
                    addedCount++;
                }
            });
            
            // 保存數據並更新UI
            saveData();
            elements.bulkPlayers.value = '';
            renderPlayersDropdown();
            renderPlayersTable();
            renderRankingTable(currentState.selectedSeason);
            
            alert(`成功新增 ${addedCount} 名球員`);
        }

        // 刪除球員
        function deletePlayer(playerId) {
            if (!confirm('確定要刪除此球員嗎？此操作無法撤銷！')) return;
            
            // 檢查球員是否有比賽記錄
            const hasResults = systemData.events.some(event => 
                event.results.some(result => result.playerId === playerId)
            );
            
            if (hasResults) {
                alert('此球員已有比賽記錄，無法刪除！');
                return;
            }
            
            // 刪除球員
            systemData.players = systemData.players.filter(p => p.id !== playerId);
            
            // 保存數據並更新UI
            saveData();
            renderPlayersDropdown();
            renderPlayersTable();
            renderRankingTable(currentState.selectedSeason);
        }

        // 生成球員ID
        function generatePlayerId() {
            const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
            let id = '';
            
            for (let i = 0; i < 6; i++) {
                id += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            
            return id;
        }

        // 查看賽事
        function viewEvent(eventId) {
            const event = systemData.events.find(e => e.id === eventId);
            if (!event) return;
            
            // 設置當前編輯狀態
            currentState.editingEvent = eventId;
            currentState.eventResults = [...event.results];
            
            // 填充表單
            elements.eventDate.value = event.date;
            elements.eventLocation.value = event.location;
            elements.eventSeason.value = event.season;
            
            // 渲染賽事結果
            renderEventResults();
            
            // 切換到賽事管理標籤
            switchTab('events');
        }

        // 渲染賽事結果
        function renderEventResults() {
            elements.eventResultsBody.innerHTML = '';
            
            // 按名次排序
            currentState.eventResults.sort((a, b) => a.rank - b.rank);
            
            currentState.eventResults.forEach(result => {
                const player = systemData.players.find(p => p.id === result.playerId);
                if (!player) return;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${result.rank}</td>
                    <td>${player.name}</td>
                    <td>${result.points}</td>
                    <td>
                        <button class="btn btn-danger delete-result" data-id="${result.playerId}">移除</button>
                    </td>
                `;
                elements.eventResultsBody.appendChild(row);
            });
            
            // 添加移除按鈕的事件監聽器
            document.querySelectorAll('.delete-result').forEach(button => {
                button.addEventListener('click', () => deleteEventResult(button.dataset.id));
            });
        }

        // 添加賽事結果
        function addEventResult() {
            const playerId = elements.selectPlayer.value;
            const rank = parseInt(elements.playerRank.value);
            
            if (!playerId || !rank) {
                alert('請選擇球員並輸入名次');
                return;
            }
            
            // 檢查是否已添加
            if (currentState.eventResults.some(r => r.playerId === playerId)) {
                alert('此球員已在此賽事中');
                return;
            }
            
            // 檢查名次是否已存在
            if (currentState.eventResults.some(r => r.rank === rank)) {
                alert('此名次已被其他球員佔用');
                return;
            }
            
            // 計算積分 (12分制)
            const points = Math.max(0, 13 - rank); // 第1名12分，第2名11分，...，第12名1分，第13名及以後0分
            
            // 添加結果
            currentState.eventResults.push({
                playerId,
                rank,
                points
            });
            
            // 重新渲染結果
            renderEventResults();
            
            // 清空輸入
            elements.selectPlayer.value = '';
            elements.playerRank.value = '';
        }

        // 處理接龍式輸入
        function processBulkResults() {
            const text = elements.bulkResults.value.trim();
            if (!text) {
                alert('請輸入球員名單');
                return;
            }
            
            const names = text.split('\n').filter(name => name.trim() !== '');
            if (names.length < 2) {
                alert('至少需要2名球員');
                return;
            }
            
            // 清空現有結果
            currentState.eventResults = [];
            
            // 為每個球員添加結果
            names.forEach((name, index) => {
                const rank = index + 1;
                const player = findPlayerByName(name.trim());
                
                if (player) {
                    const points = Math.max(0, 13 - rank); // 第1名12分，...，第12名1分，第13名及以後0分
                    
                    currentState.eventResults.push({
                        playerId: player.id,
                        rank,
                        points
                    });
                } else {
                    alert(`找不到球員: ${name}`);
                }
            });
            
            // 重新渲染結果
            renderEventResults();
        }

        // 根據姓名查找球員
        function findPlayerByName(name) {
            return systemData.players.find(player => 
                player.name === name || 
                player.name.includes(name) || 
                name.includes(player.name)
            );
        }

        // 刪除賽事結果
        function deleteEventResult(playerId) {
            currentState.eventResults = currentState.eventResults.filter(r => r.playerId !== playerId);
            renderEventResults();
        }

        // 保存賽事
        function saveEvent() {
            const date = elements.eventDate.value;
            const location = elements.eventLocation.value.trim();
            const season = elements.eventSeason.value;
            
            if (!date || !location || !season) {
                alert('請填寫所有必填欄位');
                return;
            }
            
            if (currentState.eventResults.length < 2) {
                alert('至少需要2名球員才能創建賽事');
                return;
            }
            
            // 檢查名次是否連續從1開始
            const ranks = currentState.eventResults.map(r => r.rank).sort((a, b) => a - b);
            for (let i = 0; i < ranks.length; i++) {
                if (ranks[i] !== i + 1) {
                    alert(`名次必須連續從1開始，缺少名次 ${i + 1}`);
                    return;
                }
            }
            
            // 創建或更新賽事
            if (currentState.editingEvent) {
                // 更新現有賽事
                const eventIndex = systemData.events.findIndex(e => e.id === currentState.editingEvent);
                if (eventIndex !== -1) {
                    systemData.events[eventIndex] = {
                        ...systemData.events[eventIndex],
                        date,
                        location,
                        season,
                        results: [...currentState.eventResults]
                    };
                }
            } else {
                // 創建新賽事
                systemData.events.push({
                    id: generateEventId(),
                    date,
                    location,
                    season,
                    results: [...currentState.eventResults]
                });
            }
            
            // 保存數據並更新UI
            saveData();
            cancelEventEdit();
            renderEventsTable();
            renderRankingTable(currentState.selectedSeason);
        }

        // 取消賽事編輯
        function cancelEventEdit() {
            currentState.editingEvent = null;
            currentState.eventResults = [];
            
            // 清空表單
            elements.eventDate.value = new Date().toISOString().split('T')[0];
            elements.eventLocation.value = '';
            elements.eventSeason.value = systemData.settings.currentQuarter;
            
            // 清空結果表格
            elements.eventResultsBody.innerHTML = '';
        }

        // 刪除賽事
        function deleteEvent(eventId) {
            if (!confirm('確定要刪除此賽事嗎？此操作無法撤銷！')) return;
            
            systemData.events = systemData.events.filter(e => e.id !== eventId);
            saveData();
            renderEventsTable();
            renderRankingTable(currentState.selectedSeason);
        }

        // 生成賽事ID
        function generateEventId() {
            return 'event-' + Date.now().toString(36) + Math.random().toString(36).substr(2, 5);
        }

        // 保存季度設定
        function saveQuarterSettings() {
            const quarter = elements.currentQuarter.value;
            systemData.settings.currentQuarter = quarter;
            systemData.settings.quarterStart = elements.quarterStart.value;
            systemData.settings.quarterEnd = elements.quarterEnd.value;
            
            // 更新季度數據
            if (!systemData.settings.quarters[quarter]) {
                systemData.settings.quarters[quarter] = {
                    name: `${quarter}季度`,
                    start: elements.quarterStart.value,
                    end: elements.quarterEnd.value
                };
            } else {
                systemData.settings.quarters[quarter].start = elements.quarterStart.value;
                systemData.settings.quarters[quarter].end = elements.quarterEnd.value;
            }
            
            saveData();
            updateQuarterDisplay();
            renderRankingTable(currentState.selectedSeason);
            
            alert('季度設定已更新');
        }

        // 導出數據
        function exportData() {
            elements.exportData.value = JSON.stringify(systemData, null, 2);
        }

        // 複製數據
        function copyData() {
            elements.exportData.select();
            document.execCommand('copy');
            alert('數據已複製到剪貼板');
        }

        // 下載數據
        function downloadData() {
            const dataStr = JSON.stringify(systemData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `pingpong-ranking-data-${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // 上傳數據
        function uploadData() {
            elements.fileUpload.click();
        }

        // 處理文件上傳
        function handleFileUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = function(event) {
                elements.importData.value = event.target.result;
            };
            reader.readAsText(file);
        }

        // 導入數據
        function importData() {
            try {
                const data = JSON.parse(elements.importData.value);
                
                // 簡單驗證數據結構
                if (!data.players || !data.events || !data.settings) {
                    throw new Error('無效的數據格式');
                }
                
                if (!confirm('確定要導入此數據嗎？現有數據將被覆蓋！')) return;
                
                systemData = data;
                
                // 確保quarters數據存在
                if (!systemData.settings.quarters) {
                    systemData.settings.quarters = {
                        '2025-Q2': { start: '2025-04-01', end: '2025-06-30', name: '2025年第二季度' },
                        '2025-Q3': { start: '2025-07-01', end: '2025-09-30', name: '2025年第三季度' },
                        '2025-Q4': { start: '2025-10-01', end: '2025-12-31', name: '2025年第四季度' },
                        '2026-Q1': { start: '2026-01-01', end: '2026-03-31', name: '2026年第一季度' }
                    };
                }
                
                saveData();
                
                // 重新加載所有UI
                updateQuarterDisplay();
                renderPlayersDropdown();
                renderPlayersTable();
                renderEventsTable();
                renderRankingTable(currentState.selectedSeason);
                
                alert('數據導入成功');
            } catch (error) {
                alert(`導入失敗: ${error.message}`);
            }
        }

        // 切換輸入方式
        function switchInputMethod(method) {
            currentState.inputMethod = method;
            
            // 移除所有active類
            document.querySelectorAll('.input-method-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.input-method-content').forEach(content => content.classList.remove('active'));
            
            // 添加active類到選中的tab和content
            document.querySelectorAll(`.input-method-tab[data-method="${method}"]`).forEach(tab => tab.classList.add('active'));
            document.getElementById(`${method}-input`).classList.add('active');
            if (method === 'bulk') {
                document.getElementById('bulk-event-input').classList.add('active');
            } else {
                document.getElementById('single-event-input').classList.add('active');
            }
        }

        // 切換季度篩選
        function switchSeason(season) {
            currentState.selectedSeason = season;
            renderRankingTable(season, elements.filterSearch.value);
            
            // 更新UI
            elements.seasonTabs.forEach(tab => {
                if (tab.dataset.season === season) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
        }

        // 保存數據到本地存儲
        function saveData() {
            localStorage.setItem('pingpongRankingSystem', JSON.stringify(systemData));
        }

        // 切換標籤頁
        function switchTab(tabId) {
            elements.tabs.forEach(tab => {
                if (tab.dataset.tab === tabId) {
                    tab.classList.add('active');
                } else {
                    tab.classList.remove('active');
                }
            });
            
            elements.tabContents.forEach(content => {
                if (content.id === `${tabId}-tab`) {
                    content.classList.add('active');
                } else {
                    content.classList.remove('active');
                }
            });
            
            // 如果是排名標籤，刷新數據
            if (tabId === 'ranking') {
                renderRankingTable(currentState.selectedSeason);
            }
            
            // 如果是導出標籤，刷新導出數據
            if (tabId === 'settings') {
                exportData();
            }
        }

        // 設置事件監聽器
        function setupEventListeners() {
            // 標籤頁切換
            elements.tabs.forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });
            
            // 球員管理
            elements.addPlayer.addEventListener('click', addPlayer);
            elements.addBulkPlayers.addEventListener('click', addBulkPlayers);
            
            // 賽事管理
            elements.addResult.addEventListener('click', addEventResult);
            elements.saveEvent.addEventListener('click', saveEvent);
            elements.cancelEvent.addEventListener('click', cancelEventEdit);
            elements.processBulkResults.addEventListener('click', processBulkResults);
            
            // 輸入方式切換 (球員管理)
            document.querySelectorAll('.input-method-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    switchInputMethod(tab.dataset.method);
                });
            });
            
            // 輸入方式切換 (賽事管理)
            document.querySelectorAll('#events-tab .input-method-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    const method = tab.dataset.method;
                    currentState.inputMethod = method;
                    
                    // 移除所有active類
                    document.querySelectorAll('#events-tab .input-method-tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('#events-tab .input-method-content').forEach(c => c.classList.remove('active'));
                    
                    // 添加active類到選中的tab和content
                    tab.classList.add('active');
                    if (method === 'bulk') {
                        document.getElementById('bulk-event-input').classList.add('active');
                    } else {
                        document.getElementById('single-event-input').classList.add('active');
                    }
                });
            });
            
            // 季度篩選
            elements.seasonTabs.forEach(tab => {
                tab.addEventListener('click', () => switchSeason(tab.dataset.season));
            });
            
            // 排名搜尋
            elements.filterSearch.addEventListener('input', () => {
                renderRankingTable(currentState.selectedSeason, elements.filterSearch.value);
            });
            
            // 數據導出導入
            elements.copyData.addEventListener('click', copyData);
            elements.downloadData.addEventListener('click', downloadData);
            elements.uploadData.addEventListener('click', uploadData);
            elements.fileUpload.addEventListener('change', handleFileUpload);
            elements.importSubmit.addEventListener('click', importData);
            
            // 系統設定
            elements.saveQuarter.addEventListener('click', saveQuarterSettings);
        }

        // 初始化系統
        document.addEventListener('DOMContentLoaded', initSystem);
    </script>
</body>
</html>